# げんきフェスタ2026 リポジトリ構成と改善点

## 概要

地域イベント「げんきフェスタ」の公式サイト。Astro + React のハイブリッド構成で、GitHub Pages にデプロイ。

- **URL**: https://viva-kantomi.github.io/genki-fes
- **技術スタック**: Astro 5.3 + React 19 + React Router 7 + TypeScript 5.7

---

## ディレクトリ構成

```
genki-fes/
├── .github/
│   └── workflows/
│       └── deploy-pages.yml      # GitHub Pages デプロイ（毎時自動実行）
│
├── content/
│   └── news/                     # ニュース記事（Markdown）
│       ├── 2026-02-17-site-open.md
│       └── 2026-02-20-event-info.md
│
├── public/                       # 静的アセット (2MB)
│   ├── images/
│   │   ├── top_logo.webp         # メインロゴ
│   │   ├── event_cards_*.jpg     # イベントカード画像
│   │   ├── top_images/           # ヒーロー背景画像
│   │   └── common/               # SNSアイコン、クラウド画像
│   ├── assets/
│   │   └── genki-festa-2026/
│   │       └── shops/            # 出店情報画像
│   ├── data/
│   │   └── note-articles.json    # Note.com記事キャッシュ（ビルド時生成）
│   └── og-default.png            # OGP画像
│
├── scripts/
│   ├── fetch-note-articles.js    # Note.com API 記事取得
│   └── convert-images.js         # 画像変換（WebP）
│
├── src/
│   ├── components/
│   │   └── react/
│   │       ├── App.tsx           # React Router ルート (83行)
│   │       ├── Countdown.tsx     # カウントダウン表示 (146行)
│   │       ├── Layout/
│   │       │   ├── Header.tsx    # ヘッダー (34行)
│   │       │   ├── Footer.tsx    # フッター (22行)
│   │       │   └── MobileNav.tsx # モバイルナビ (19行)
│   │       └── pages/
│   │           ├── Home.tsx      # ホーム (807行) ⚠️ 巨大
│   │           ├── Event2026.tsx # 特設ページ (850行) ✅ 改善済み
│   │           ├── Events.tsx    # イベント一覧 (453行)
│   │           ├── About.tsx     # 企業情報 (378行)
│   │           ├── History.tsx   # 活動履歴 (289行)
│   │           ├── NewsList.tsx  # ニュース一覧 (94行)
│   │           ├── NewsDetail.tsx# ニュース詳細 (40行)
│   │           └── NoteDetail.tsx# Note記事詳細 (141行)
│   │
│   ├── data/
│   │   ├── events.json           # イベントデータ (102行)
│   │   └── shops.json            # 出店・エリア情報 (新規)
│   │
│   ├── layouts/
│   │   └── Layout.astro          # マスターレイアウト (223行) ✅ 改善済み
│   │
│   ├── styles/
│   │   └── global.css            # グローバルスタイル (971行)
│   │
│   ├── lib/
│   │   ├── events.ts             # イベントデータ管理 (42行)
│   │   ├── note.ts               # Note.com連携 (71行)
│   │   ├── path.ts               # パスユーティリティ (31行)
│   │   ├── date.ts               # 日付ユーティリティ (22行)
│   │   └── seo.ts                # SEO関連 (12行)
│   │
│   ├── pages/
│   │   ├── index.astro           # ホームページ (1,115行) ⚠️ 巨大
│   │   └── 404.astro             # 404ページ (7行)
│   │
│   └── content.config.ts         # Astro Content Collection設定 (16行)
│
├── .env.development              # 開発環境設定
├── .env.production               # 本番環境設定
├── astro.config.mjs              # Astro設定
├── package.json                  # 依存パッケージ
└── tsconfig.json                 # TypeScript設定
```

**総ソースコード行数**: 約5,977行（src/配下）

---

## 技術構成

### フレームワーク
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Astro | 5.3.0 | 静的サイト生成（SSG） |
| React | 19.2.4 | SPA / インタラクティブUI |
| React Router | 7.13.0 | クライアントサイドルーティング |
| TypeScript | 5.7.0 | 型安全性 |

### ビルドツール・プラグイン
- **@astrojs/react**: AstroにReactサポートを追加
- **@astrojs/sitemap**: サイトマップ自動生成
- **Sharp**: 画像処理・最適化

### アーキテクチャ
**ハイブリッド構成**: Astro（静的生成）+ React SPA（動的コンテンツ）

- Astroで `index.astro` と `404.astro` を静的生成
- PC表示: 3カラムレイアウト（左サイドバー + 中央SPA + 右サイドバー）
- 中央の「Phone Frame」内でReact Routerによるクライアントサイドナビゲーション

---

## データ管理

### 1. イベントデータ (`src/data/events.json`)
```json
{
  "id": "genki-festa-2026",
  "title": "げんきフェスタ",
  "date": "2026年5月24日（日）",
  "description": "...",
  "details": ["..."],
  "comments": ["..."],
  "link": "/genki-festa-2026/",
  "image": "/images/event_cards_genki.jpg",
  "featured": true,
  "badge": "NOW",
  "order": 1,
  "category": "yearly"
}
```

### 2. ニュース記事 (`content/news/*.md`)
Astro Content Collection を使用。Markdownフロントマター形式。

### 3. Note.com連携
- ビルド時に `scripts/fetch-note-articles.js` で記事を取得
- `public/data/note-articles.json` にキャッシュ
- ユーザーID: `viva_kantomi`

---

## 環境変数

| 変数名 | 開発 | 本番 | 用途 |
|--------|------|------|------|
| `PUBLIC_SITE_URL` | `http://localhost:4321` | `https://viva-kantomi.github.io` | サイトURL |
| `PUBLIC_BASE_PATH` | (空) | `/genki-fes` | ベースパス |
| `PUBLIC_SHOW_GENKI_FESTA_SPECIAL` | `true` | `true` | 特設ページ表示制御 |

---

## CI/CD

### GitHub Actions (`.github/workflows/deploy-pages.yml`)

**トリガー**:
- `main` ブランチへのpush
- 毎時0分（1時間ごと）のスケジュール実行
- 手動トリガー

**ビルドフロー**:
1. `npm ci` - 依存パッケージインストール
2. `npm run prebuild` - Note.com記事取得
3. `npm run build` - TypeScriptチェック + Astroビルド
4. GitHub Pages にデプロイ

---

## 問題点と改善提案

### 🔴 重大な問題

#### 1. 巨大なコンポーネントファイル
| ファイル | 行数 | 問題点 |
|----------|------|--------|
| `Layout.astro` | 1,190行 | スタイルとロジックが混在 |
| `index.astro` | 1,115行 | 重複コードが多い |
| `Event2026.tsx` | 965行 | 出店データがハードコード |
| `Home.tsx` | 807行 | スタイルがインライン |

**改善案**:
- CSSを外部ファイル（`*.module.css`）に分離
- 共通コンポーネントの抽出
- 出店情報を `data/shops.json` に分離

#### 2. Astro と React の重複コンテンツ
- `index.astro` と `Home.tsx` が同様のコンテンツを持つ
- SEO的には良いが、メンテナンスコストが高い

**改善案**:
- どちらか一方に統一
- または、共通データソースからの生成に変更

#### 3. ~~events.json のスキーマ不整合~~ ✅ 解決済み
- ~~`Event` 型に `details`, `comments`, `category` フィールドがあるが、`lib/events.ts` の型定義に含まれていない~~
- **対応完了**: `lib/events.ts` に不足していたフィールドを追加

### 🟡 中程度の問題

#### 4. ~~Zone.Identifier ファイルの混入~~ ✅ 解決済み
- ~~Windows環境からコピーした画像に `*.jpg:Zone.Identifier` ファイルが含まれている~~
- **対応完了**: 20ファイルを削除、`.gitignore` に追加

#### 5. ~~テストデータの混在~~ ✅ 解決済み
- ~~`events.json` に「テストイベント3」のような空データが含まれている~~
- **対応完了**: 空データを削除、IDを適切な名前にリネーム

#### 6. 画像最適化の不徹底
- `top_logo.png` (490KB) と `top_logo.webp` (67KB) が両方存在
- 一部の画像が最適化されていない（`og-default.png`: 681KB）

**改善案**:
- Astro の `<Image>` コンポーネントを使用
- すべての画像をWebP形式に統一
- OGP画像も適切なサイズに最適化

#### 7. ~~フィーチャーブランチがデプロイ対象~~ ✅ 解決済み
- ~~`feat/mobile-app-shell-spa` ブランチへのpushでもデプロイが実行される~~
- **対応完了**: デプロイトリガーを `main` のみに変更

### 🟢 軽微な問題・改善提案

#### 8. スタイリング手法の統一
現在、以下が混在:
- Astro `<style>` タグ
- Reactインラインスタイル
- CSS変数

**改善案**:
- CSS Modules または Tailwind CSS への統一
- グローバルスタイルの整理

#### 9. コンポーネント分割の推奨
`Event2026.tsx` の出店情報表示部分を以下に分割:
- `ShopCard.tsx` - 個別出店カード
- `ShopList.tsx` - 出店一覧
- `AreaSection.tsx` - エリア別セクション

#### 10. エラーハンドリングの強化
Note.com API取得失敗時の処理が弱い。

**改善案**:
- 前回のキャッシュを保持
- フォールバックコンテンツの表示

#### 11. アクセシビリティ改善
- 画像の `alt` 属性の充実
- フォーカス管理の改善
- キーボードナビゲーション対応

#### 12. パフォーマンス改善
- 画像の遅延読み込み（`loading="lazy"`）
- React コンポーネントの `React.memo` 適用
- バンドルサイズの分析と最適化

---

## 推奨アクションプラン

### Phase 1: 緊急対応 ✅ 完了 (2026-02-20)
1. [x] Zone.Identifier ファイルの削除
   - `public/` 配下の20個のファイルを削除
   - `.gitignore` に `*:Zone.Identifier` を追加
2. [x] テストデータの整理
   - 空の「テストイベント3」を削除
   - `test-event-1` → `university-collab` にリネーム
   - `test-event-2` → `regional-study` にリネーム
3. [x] events.ts の型定義修正
   - `details: string[]` を追加
   - `comments: string[]` を追加
   - `category: 'yearly' | 'weekly' | 'irregular'` を追加
4. [x] 未使用コードの削除
   - `Event2026.tsx` から未使用の `Link` import を削除
   - 未使用の `activeArea` 変数を修正
5. [x] デプロイトリガーの修正
   - `feat/mobile-app-shell-spa` をトリガーから削除

### Phase 2: コード品質向上 ✅ 完了
1. [x] CSSの外部ファイル分離
   - `src/styles/global.css` を新規作成（971行）
   - `Layout.astro` から約970行のCSSを分離
   - `Layout.astro`: 1,190行 → 223行 に削減
2. [x] 出店データの JSON 化
   - `src/data/shops.json` を新規作成
   - `Event2026.tsx` からハードコードされたデータを分離
   - エリア情報・出店情報をJSON管理に移行
3. [ ] 共通コンポーネントの抽出（将来対応）

### Phase 3: 最適化 ✅ 完了
1. [x] 画像のWebP化
   - `index.astro` の `genki_festa_logo.png` → `.webp` に変更
   - `top_images/*.png` → `.webp` に変更（9ファイル）
   - 未使用のPNGファイルを削除
   - **publicディレクトリ: 13MB → 2MB に大幅削減**
2. [ ] OGP画像の最適化 (681KB - SNS用のため保留)
3. [ ] バンドルサイズ削減（将来対応）

### Phase 4: 長期改善
1. [ ] スタイリング手法の統一（CSS Modules推奨） → **詳細は下記セクション参照**
2. [ ] テストの追加
3. [ ] ドキュメントの整備

---

## スタイリング統一計画（Phase 4-1 詳細）

### 現状分析（2026-02-20 調査完了）

| 手法 | 使用箇所 | 備考 |
|------|----------|------|
| グローバルCSS | `src/styles/global.css` (972行) | CSS変数、レイアウト、レスポンシブ |
| Astro `<style>` | `index.astro`, `404.astro`, `Layout.astro` | スコープ付きCSS |
| Reactインラインスタイル | `Event2026.tsx`, `Home.tsx` | 最小限（CSS変数設定等） |
| CSS Modules | なし | 未導入 |

### 対象ファイル一覧

#### Reactコンポーネント（CSS Modules化対象）
| ファイル | 行数 | 優先度 | ステータス |
|----------|------|--------|------------|
| `pages/Home.tsx` | 807行→239行 | 高 | [x] ✅ 完了 |
| `pages/Event2026.tsx` | 850行→295行 | 高 | [x] ✅ 完了 |
| `pages/Events.tsx` | 453行→159行 | 中 | [x] ✅ 完了 |
| `pages/About.tsx` | 378行→82行 | 中 | [x] ✅ 完了 |
| `pages/History.tsx` | 289行→117行 | 中 | [x] ✅ 完了 |
| `pages/NewsList.tsx` | 94行 | 低 | [ ] 未着手 |
| `pages/NewsDetail.tsx` | 40行 | 低 | [ ] 未着手 |
| `pages/NoteDetail.tsx` | 141行 | 低 | [ ] 未着手 |
| `Layout/Header.tsx` | 34行 | 低 | [ ] 未着手 |
| `Layout/Footer.tsx` | 22行 | 低 | [ ] 未着手 |
| `Layout/MobileNav.tsx` | 19行 | 低 | [ ] 未着手 |
| `Countdown.tsx` | 146行 | 低 | [ ] 未着手 |
| `App.tsx` | 83行 | 低 | [ ] 未着手 |

#### Astroファイル（CSS分離対象）
| ファイル | 行数 | 優先度 | ステータス |
|----------|------|--------|------------|
| `pages/index.astro` | 1,115行 | 高 | [ ] 未着手 |
| `pages/404.astro` | 7行 | 低 | [ ] 未着手 |
| `layouts/Layout.astro` | 223行 | - | ✅ 済（global.cssに分離済） |

### 作業ステップ

#### Step 1: 準備
- [x] CSS Modules の命名規則を決定 → **camelCase** に決定
- [x] ディレクトリ構成を決定 → **コンポーネント横並び方式**（`Home.tsx` と `Home.module.css` を同じフォルダに配置）

#### Step 2: Reactコンポーネント（優先度高） ✅ 完了
- [x] `Home.tsx` → `Home.module.css` 作成・移行
- [x] `Event2026.tsx` → `Event2026.module.css` 作成・移行

#### Step 3: Reactコンポーネント（優先度中） ✅ 完了
- [x] `Events.tsx` → `Events.module.css` 作成・移行
- [x] `About.tsx` → `About.module.css` 作成・移行
- [x] `History.tsx` → `History.module.css` 作成・移行

#### Step 4: Reactコンポーネント（優先度低）
- [ ] 残りのコンポーネントを順次対応（8ファイル）

#### Step 5: Astroファイル
- [ ] `index.astro` の `<style>` を外部CSS化

#### Step 6: 整理・最終確認
- [ ] 未使用CSSの削除
- [ ] ビルド確認・動作テスト

### 進捗サマリー
- **総対象ファイル数**: 15ファイル
- **完了**: 5 / 15 (33%)
- **進行中**: 0
- **ステータス**: 🟡 進行中（優先度高・中 完了）

---

## 参考リンク

- [Astro ドキュメント](https://docs.astro.build/)
- [React Router ドキュメント](https://reactrouter.com/)
- [GitHub Pages](https://pages.github.com/)
