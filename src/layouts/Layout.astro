---
// SP枠内のみReact Routerで差し替え、左右サイドバーはAstroで静的配置
import { getPath } from '../lib/path';
import { App } from '../components/react/App';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const { title, description = '群馬県富岡市発！げんき塾チームが主催する「げんきフェスタ」公式サイト。地域を元気にするイベント・お祭りの企画運営。音楽、グルメ、ワークショップなど家族で楽しめるイベント情報をお届けします。', ogImage = '/images/og-default.png' } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
    <meta name="generator" content={Astro.generator} />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet" />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content="げんきフェスタ,群馬県,富岡市,イベント,祭,フェス,地域イベント,げんき塾チーム" />
    <link rel="canonical" href={canonicalURL} />
    <link rel="alternate" hreflang="ja" href={canonicalURL} />

    <!-- Mobile -->
    <meta name="theme-color" content="#d92325" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- OGP -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, Astro.site)} />
    <meta property="og:locale" content="ja_JP" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, Astro.site)} />

    <!-- JSON-LD 構造化データ -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "げんき塾チーム",
      "description": "群馬県富岡市を拠点とする地域イベント企画チーム。げんきフェスタをはじめ、地域を元気にするお祭り・イベントを企画運営。",
      "url": "https://viva-kantomi.github.io/genki-fes/",
      "logo": "https://viva-kantomi.github.io/genki-fes/images/og-default.png",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "富岡市",
        "addressRegion": "群馬県",
        "addressCountry": "JP"
      },
      "sameAs": []
    })} />
  </head>
  <body>
    <!-- PC用3カラムレイアウト -->
    <div class="desktop-layout">
      <!-- 左サイドバー（カウントダウン・動画） -->
      <aside class="sidebar sidebar-left">
        <div class="sidebar-left-header">
          <p class="sidebar-left-title">げんきフェスタ2026 <span class="sidebar-left-date">5.24 SUN</span></p>
          <p class="countdown-hero-label">開催まであと</p>
          <div class="countdown-hero">
            <div class="countdown-hero-number" id="countdownDays">--</div>
            <p class="countdown-hero-unit">日</p>
          </div>
        </div>
        <div class="sidebar-content">
          <div class="sidebar-section">
            <p class="video-label">2025年のげんきフェスタの様子</p>
            <div class="video-container">
              <div id="youtube-player"></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- 中央：SP枠（Reactアプリ） -->
      <div class="phone-frame">
        <div class="phone-frame-inner">
          <App client:only="react" />
        </div>
      </div>

      <!-- 右サイドバー（メニュー・SNS） -->
      <aside class="sidebar sidebar-right">
        <div class="sidebar-right-menu">
          <p class="sidebar-menu-title">メニュー</p>
          <nav class="sidebar-nav">
            <a href={getPath('/')} class="sidebar-nav-link sidebar-nav-blue">トップ</a>
            <a href={getPath('/events/')} class="sidebar-nav-link sidebar-nav-yellow">イベント詳細</a>
            <a href={getPath('/history/')} class="sidebar-nav-link sidebar-nav-red">これまでの活動</a>
            <a href={getPath('/genki-festa-2026/')} class="sidebar-nav-link sidebar-nav-blue">2026 げんきフェスタ<br>特設ページ</a>
            <a href={getPath('/news/')} class="sidebar-nav-link sidebar-nav-yellow">お知らせ</a>
            <a href={getPath('/about/')} class="sidebar-nav-link sidebar-nav-red">私たちについて</a>
          </nav>
        </div>
        <div class="sidebar-right-sns">
          <p class="sidebar-sns-title">SNS</p>
          <div class="sns-links">
            <a href="#" class="sns-link" aria-label="Instagram">
              <img src={`${import.meta.env.BASE_URL}images/common/sns/icons8-instagram-100.png`} alt="Instagram" width="32" height="32" />
            </a>
            <a href="#" class="sns-link" aria-label="YouTube">
              <img src={`${import.meta.env.BASE_URL}images/common/sns/icons8-youtube-100.png`} alt="YouTube" width="32" height="32" />
            </a>
            <a href="#" class="sns-link" aria-label="Facebook">
              <img src={`${import.meta.env.BASE_URL}images/common/sns/icons8-facebook-100.png`} alt="Facebook" width="32" height="32" />
            </a>
          </div>
        </div>
      </aside>
    </div>

    <script>
      // サイドバーのリンクをクリックしたらReact Router経由で遷移
      document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = (link as HTMLAnchorElement).getAttribute('href');
          if (href) {
            // React Routerはbasenameを自動付与するので、ベースパスを除去して渡す
            const basePath = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
            const path = basePath && href.startsWith(basePath)
              ? href.slice(basePath.length) || '/'
              : href;

            // Reactがマウント済みかチェック（spa-navigate-readyフラグ）
            const dispatchNavigate = () => {
              window.dispatchEvent(new CustomEvent('spa-navigate', {
                detail: { path }
              }));
            };

            if ((window as any).__spaNavigateReady) {
              dispatchNavigate();
            } else {
              // Reactがまだ準備中の場合、少し待ってリトライ
              const checkReady = setInterval(() => {
                if ((window as any).__spaNavigateReady) {
                  clearInterval(checkReady);
                  dispatchNavigate();
                }
              }, 10);
              // 最大500ms待つ
              setTimeout(() => clearInterval(checkReady), 500);
            }
          }
        });
      });

      // カウントダウン
      function updateCountdown() {
        const eventDate = new Date('2026-05-24T00:00:00');
        const now = new Date();
        const diff = eventDate.getTime() - now.getTime();
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        const countdownEl = document.getElementById('countdownDays');
        if (countdownEl) {
          countdownEl.textContent = days > 0 ? days.toString() : '0';
        }
      }
      updateCountdown();

      // YouTube IFrame API
      function initYouTubePlayer() {
        const playerEl = document.getElementById('youtube-player');
        // 既にiframeになっている場合はスキップ
        if (!playerEl || playerEl.tagName === 'IFRAME') return;

        new (window as any).YT.Player('youtube-player', {
          videoId: '1OqHFpav2X0',
          host: 'https://www.youtube-nocookie.com',
          playerVars: {
            autoplay: 0,
            loop: 1,
            playlist: '1OqHFpav2X0',
            controls: 1,
            rel: 0,
            origin: window.location.origin
          },
          events: {
            onReady: function(event: any) {
              event.target.setVolume(10);
            }
          }
        });
      }

      // YouTube API がまだ読み込まれていない場合
      if (!(window as any).YT) {
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode?.insertBefore(tag, firstScriptTag);

        (window as any).onYouTubeIframeAPIReady = initYouTubePlayer;
      } else {
        // 既にAPIが読み込まれている場合は直接初期化
        initYouTubePlayer();
      }
    </script>
  </body>
</html>

